window.onload = init;

//function to add event listner on evry button
function init(){
  // console.log(document.getElementById("is_configurable"));
  console.log("config.js");
  if(document.getElementById("is_configurable")){
    //all img of the document
    var clickable = document.getElementsByTagName("img");
    //setting printed price to product price

    for(var i = 0; i < clickable.length; i++){

      //if img has class variant_img : we add the eventListener
      if(clickable[i].className.indexOf("variant_img") >= 0){
          clickable[i].addEventListener("click",clickOption);
          clickable[i].addEventListener("mouseover",displayBigIcon);
          clickable[i].addEventListener("mouseleave", undisplayBigIcon);
      }
    }
    //all del_button (button on the summary tab)
     var clearBtn = document.getElementsByClassName("del-variant");
     for(b = 0; b<clearBtn.length;b++){

      clearBtn[b].addEventListener("click",clearConfig);
     }

    var product_details = document.getElementById("product_details")
    //this part remove product detail of the product page (no solution founded to do it in XML)
    for(var w = 0; w < product_details.childNodes.length; w++){
        product_details.remove(product_details[w]);
      }
    }
    setTabs();
}

//function executed on the click on a variant image
function clickOption(){
    element = this;
    // parent = parent div of the img (we use parentElement twice cause the img element is in a span generated by odoo)
    var parent = element.parentElement.parentElement.className;
    //childes = tabs that contain all variant img ()
    childes = document.getElementsByClassName(parent);
    //this step delete active class of active variant and set her to unactive
    for(var x = 0; x < childes.length; x++){
        //child = <div><span><img></span><input hidden></div>
        child = childes[x];
        //imgChild is the img in the div
        imgChild = child.childNodes[1].childNodes[0];
        classe = imgChild.classList;
        for(var i = 0; i<classe.length; i++){
            if(classe[i] == "active_var"){
              imgChild.classList.remove("active_var");
              imgChild.className += " unactive_var";
            }

        }

    }
    
    //step to set active the new active variant
    element.classList.remove("unactive_var");
    if(!element.classList.contains("active_var")){
      element.className += " active_var";
    }
    //call to update image function
    updateImage(element, parent);
    //moving the selected icon on the new active variant
    select_img = document.getElementById("selected_"+ parent);
    element.parentElement.parentElement.appendChild(select_img);
    //call to update config tab
    updateConfigTab();
}

//this function update the configuration image
function updateImage(element, parent){

    select_name = "selected_"+ parent;
    //we are taking the parent div classname (variant.name)
    layer = element.parentElement.parentElement.className;
    //all layer have id : lay_variant.name
    layer = "lay_"+layer
    //div that contain background image and all layer
    backgroundDiv = document.getElementById("config_out");
    //list of all layer on the img
    backChilds = backgroundDiv.childNodes;
    //we set var img to null
    img = null;
    //generating src of the new variant simage
    newSrc = genSrc(element.src);
    //step to check if layer already exist
    for(var i =0; i<backChilds.length; i++){

      backChild = backChilds[i];
      backid = "lay_"+backChild.id;
      //if img exist : img = img of the layer
      if(backChild.id == layer){
        img = backChild.firstChild;
      }
    }
    //if img !=null, layer exist we change img src
    if(img != null){
      img.src = newSrc;
    }else{
        //generating the selected icon in the variant tabs
        selected_img = document.createElement("img");
        selected_img.style="position:absolute;margin:-73px 0px 0px 0px";
        selected_img.id=select_name;
        selected_img.className = "selected_variant_line";
        selected_img.src="/configOdoo/static/img/selected.png";
        //appending this img to selected variant div
        element.parentElement.parentElement.appendChild(selected_img);

        //generating layer's div and img
        divImg = document.createElement("div");
        divImg.id= layer;
        backgroundDiv.insertBefore(divImg, backgroundDiv.firstChild);
        layerImg = document.createElement("img");
        layerImg.style = "position:absolute;width:94%; height:auto;z-index:1;";
        layerImg.src = newSrc;
        divImg.appendChild(layerImg);
      }
}

//this function generate the src of the variant img from the icon image
function genSrc(src){
    //src is the variant's icon image src : this function have to change the icon parameters of the url to image
    //src exemple http://ip:port/web/image/configurateur_product.line/22/icon?unique=6346df6
    splitC = src.split("?");
    newSrc = splitC[0].substr(0, splitC[0].length-4);
    newSrc = newSrc + "image?" + splitC[1];
    return newSrc;
}


// this function set href of the variant tabs menu (no solution do do it in XML)
function setTabs(){

  var tabs_menu = document.getElementById("tabs-menu").childNodes;
  for(t = 0; t<tabs_menu.length; t++){
    if(tabs_menu[t].nodeName == "LI"){

      variant_name = tabs_menu[t].childNodes[0].childNodes[0].innerHTML;
      tabs_menu[t].childNodes[0].href = "#"+variant_name; 
    }
  }
}

//update the configuration tab
function updateConfigTab(){
  //evry element with the class active_var
  var active_var = document.getElementsByClassName("active_var");  
  //summary config childe node
  summary = document.getElementById("summary_line").childNodes[3].childNodes;

  var_out = document.getElementsByClassName("var_out");
  //for each active element
  for(var p = 0; p<active_var.length;p++){
    //if the element is an img element (clicked img)
    if(active_var[p].nodeName == "IMG"){
      //we pick up the hiden input that contain the choosen variant_line libelle
      /*console.log(active_var[p]);*/
      active_line_lib = active_var[p].parentElement.parentElement.childNodes[3];
      console.log(active_var[p].parentElement.parentElement);
      ref = active_var[p].parentElement.parentElement.getElementsByClassName("line_name")[0].value;
      //variant's extra price
      //parent div class is the variant name
      variant = active_var[p].parentElement.parentElement.className;

      for(var n = 0; n< var_out.length; n++){
        if(var_out[n].nodeName == "H5"){
          td_variant = var_out[n].childNodes[1].value;

          if(td_variant == variant){

            out = active_var[p].src;
            var_out[n].getElementsByClassName("ref_output")[0].innerHTML = ref;
            var_out[n].childNodes[0].src = out;
            /*console.log(var_out[n].childNodes)*/
          }
        }
      }
    }
  }
  setVariantString()
}

//function that clear configuration (activated by del button on summary tab)
function clearConfig(){

  var variant_name = this.parentElement.childNodes[1].value;

  //first step : delete variant layer on the product image
  layer_name = "lay_"+variant_name;
  layer = document.getElementById(layer_name);
  layer.parentElement.removeChild(layer);

  //second step : delete variant info in summary tab
  //*this is the clicked button
  this.parentElement.parentElement.parentElement.childNodes[3].childNodes[1].childNodes[0].src = "/configOdoo/static/img/void.png";
  this.parentElement.parentElement.parentElement.getElementsByClassName("ref_output")[0].innerHTML = "";


  //third step : delete selected icon on variant image
  var active_variant = document.getElementsByClassName("active_var");

  for(a = 0;a<active_variant.length;a++){

    active_class = active_variant[a].parentElement.parentElement.classList;
    for(c=0;c<active_class.length;c++){
      if(active_class[c] == variant_name){
        active_variant_img = active_variant[a];
        
        //set to unactive the active img
        active_variant_img.classList.remove("active_var");
        active_variant_img.className += " unactive_var";
        
        //removing the selected icon
        active_parent = active_variant_img.parentElement.parentElement;
        console.log(active_parent.childNodes);
        console.log(active_parent.childNodes[11]);
        active_parent.removeChild(active_parent.childNodes[13]);
      }
    }
  }
}

//this function change the + and - for the different material accordion
$(function() {
  $(".expand").on( "click", function() {
    // $(this).next().slideToggle(200);
    $expand = $(this).find(">:first-child");
    
    if($expand.text() == "+") {
      $expand.text("-");
    } else {
      $expand.text("+");
    }
  });
});

function setVariantString(){

  active_element = document.getElementsByClassName("active_var");
  /*console.log(active_element);*/
  var idList = "";
  for(f=0;f<active_element.length;f++){
  
    idList += active_element[f].parentElement.parentElement.childNodes[7].value +",";
    variant_ref = active_element[f].parentElement.parentElement.childNodes[7].value;
    variant = active_element[f].parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.id+"_out";
    console.log(document.getElementById(variant));
    document.getElementById(variant).value = variant_ref;
  }
  document.getElementById('variant_lst').value = idList;
}



function displayBigIcon(){
  event.target.parentElement.parentElement.childNodes[11].firstChild.style.visibility = "visible";
}

function undisplayBigIcon(){
  event.target.parentElement.parentElement.childNodes[11].firstChild.style.visibility = "hidden";
}
